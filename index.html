<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–£—á–µ—Ç —Ä–∞—Å—Å—Ä–æ—á–µ–∫</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body {
      font-family: sans-serif;
      background: #f4f4f4;
      padding: 20px;
      max-width: 960px;
      margin: auto;
    }
    h1, h2 {
      text-align: center;
    }
    input, button, textarea {
      padding: 10px;
      font-size: 16px;
      width: 100%;
      margin-top: 10px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      background: white;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th {
      background: #007bff;
      color: white;
    }
    .delete-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
    }
    .pay-btn {
      background: #28a745;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
    }
    @media (max-width: 600px) {
      table, thead, tbody, th, td, tr {
        display: block;
      }
      th {
        position: sticky;
        top: 0;
      }
      td {
        border: none;
        border-bottom: 1px solid #ddd;
      }
    }
  </style>
</head>
<body>

  <h1>–£—á—ë—Ç —Ä–∞—Å—Å—Ä–æ—á–µ–∫</h1>

  <input type="text" id="search" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∫–ª–∏–µ–Ω—Ç—É..." oninput="renderTable()">

  <input type="text" id="client" placeholder="–ò–º—è –∫–ª–∏–µ–Ω—Ç–∞">
  <input type="text" id="amount" placeholder="–°—É–º–º–∞ (‚ÇΩ)">
  <input type="text" id="months" placeholder="–°—Ä–æ–∫ (–º–µ—Å.)">
  <input type="text" id="rate" placeholder="–ü—Ä–æ—Ü–µ–Ω—Ç (%)">
  <button onclick="addEntry()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
  <button onclick="exportCSV()">üì§ –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>

  <table>
    <thead>
      <tr>
        <th>–ö–ª–∏–µ–Ω—Ç</th>
        <th>–°—É–º–º–∞</th>
        <th>–°—Ä–æ–∫</th>
        <th>%</th>
        <th>–î–∞—Ç–∞</th>
        <th>–û–ø–ª–∞—Ç—ã</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
      </tr>
    </thead>
    <tbody id="tableBody"></tbody>
  </table>

  <script>
    let data = JSON.parse(localStorage.getItem('installments')) || [];

    function saveToStorage() {
      localStorage.setItem('installments', JSON.stringify(data));
    }

    function addEntry() {
      const client = document.getElementById('client').value.trim();
      const amount = document.getElementById('amount').value.trim();
      const months = document.getElementById('months').value.trim();
      const rate = document.getElementById('rate').value.trim();
      const date = new Date().toLocaleDateString();

      if (!client || !amount || !months || !rate) {
        alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
        return;
      }

      data.push({ client, amount, months, rate, date, payments: [] });
      saveToStorage();
      renderTable();

      // –û—á–∏—Å—Ç–∫–∞
      document.getElementById('client').value = '';
      document.getElementById('amount').value = '';
      document.getElementById('months').value = '';
      document.getElementById('rate').value = '';
    }

    function deleteEntry(index) {
      if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å?')) {
        data.splice(index, 1);
        saveToStorage();
        renderTable();
      }
    }

    function addPayment(index) {
      const amount = prompt("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –æ–ø–ª–∞—Ç—ã:");
      if (!amount || isNaN(amount)) return;

      const date = new Date().toLocaleDateString();
      data[index].payments.push({ amount, date });
      saveToStorage();
      renderTable();
    }

    function renderTable() {
      const tableBody = document.getElementById('tableBody');
      const search = document.getElementById('search').value.toLowerCase();
      tableBody.innerHTML = '';

      data.forEach((entry, index) => {
        if (!entry.client.toLowerCase().includes(search)) return;

        const paymentsList = entry.payments.map(p => `üí∏ ${p.amount}‚ÇΩ (${p.date})`).join('<br>');
        const row = document.createElement('tr');
        row.innerHTML = `
          <td>${entry.client}</td>
          <td>${entry.amount}</td>
          <td>${entry.months}</td>
          <td>${entry.rate}</td>
          <td>${entry.date}</td>
          <td>${paymentsList || '‚Äî'}</td>
          <td>
            <button class="pay-btn" onclick="addPayment(${index})">üí≥ –û–ø–ª–∞—Ç–∞</button><br><br>
            <button class="delete-btn" onclick="deleteEntry(${index})">–£–¥–∞–ª–∏—Ç—å</button>
          </td>
        `;
        tableBody.appendChild(row);
      });
    }

    function exportCSV() {
      let csv = "–ö–ª–∏–µ–Ω—Ç,–°—É–º–º–∞,–°—Ä–æ–∫,–ü—Ä–æ—Ü–µ–Ω—Ç,–î–∞—Ç–∞,–û–ø–ª–∞—Ç—ã\n";
      data.forEach(entry => {
        const pays = entry.payments.map(p => `${p.amount}‚ÇΩ(${p.date})`).join(" | ");
        csv += `${entry.client},${entry.amount},${entry.months},${entry.rate},${entry.date},"${pays}"\n`;
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "rassrochki.csv";
      link.click();
    }

    renderTable();
  </script>

</body>
</html>
